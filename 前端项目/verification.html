<!DOCTYPE html>
<script src="assets/bootstrap/js/jquery/2.0.0/jquery.min.js"></script>
<link href="assets/bootstrap/css/bootstrap/3.3.6/bootstrap.min.css" rel="stylesheet" />
<link href="assets/css/style.css" rel="stylesheet" />
<link href="assets/css/media-queries.css" rel="stylesheet"/>
<link href="assets/fonts/style.css" rel="stylesheet"/>
<link href="assets/css/animate.css" rel="stylesheet"/>
<link rel="stylesheet" href="assets/css/fileinput.css" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:700,300,400">
<script src="assets/bootstrap/js/bootstrap/3.3.6/bootstrap.min.js"></script>
<script src="assets/bootstrap/js/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/fileinput.js" ></script>
<script type="text/javascript" src="assets/js/spark-md5.js"></script>

<html>
	<head>
		<meta charset="UTF-8">
		<title>验证</title>
		
		<script>
			
			var k_search;
			function calculate(){ 
				clear();
    var fileReader = new FileReader(),  
        k=document.getElementById('k'); 
        blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice,  
        file = document.getElementById("file").files[0],  
        chunkSize = 2097152,  
        // read in chunks of 2MB  
        chunks = Math.ceil(file.size / chunkSize),  
        currentChunk = 0,  
        spark = new SparkMD5();  

    fileReader.onload = function(e) {  
        console.log("read chunk nr", currentChunk + 1, "of", chunks);  
        spark.appendBinary(e.target.result); // append binary string  
        currentChunk++;  

        if (currentChunk < chunks) {  
            loadNext();  
        }  
        else {  
            console.log("finished loading");  
			var flag = spark.end();
            k.innerText="文件的hash值为："+flag;
			k_search=flag;
            console.info("computed hash", spark.end()); // compute hash  
        }  
    };  

    function loadNext() {  
        var start = currentChunk * chunkSize,  
            end = start + chunkSize >= file.size ? file.size : start + chunkSize;  

        fileReader.readAsBinaryString(blobSlice.call(file, start, end));  
    };  

    loadNext();  
}  

	function clear()
		{
			$("#table tbody").html("");
		}
	function search(){
		clear();
	//var a = document.getElementById('k').value;
	$.ajax({
    url:"/sign?hash="+k_search,    //请求的url地址
    dataType:"text",   //返回格式为json
    async:true,//请求是否异步，默认为异步，这也是ajax重要特性
    type:"GET",   //请求方式
    success:function(req){
		
		var st = req.substring(14);
		if(st[1]!="]")
			{
				var table=document.getElementById("table");
				var tr = "<tr><td>"  + "hash值" + "</td><td>" +"组织名称"+"</td><td>"+"法人"+"</td><td>"+"备注"+"</td><td>"+"修改时间"+"</td></tr>";
				$("table").append(tr);
		
		var jsonArray=eval(st);  
		for(var i=0; i<jsonArray.length; i++)   
        {   
			var json = eval(jsonArray[i]);
			var key = json.Key;  //主键
			var record = json.Record;
			var hash=record.hash;	//hash
			var keys=record.keys;	//keys
			var filename_td = keys.filename;
			var oname_td = keys.oname;
			var pname_td = keys.pname;
			var oth_td = keys.oth;
			var time=record.time;	//time
			time = time*1000;
				var date = new Date(time);
				Y = date.getFullYear() + '-';
				M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
				D = date.getDate() + ' ';
				h = date.getHours() + ':';
				m = date.getMinutes() + ':';
				s = date.getSeconds(); 
				var time_bj=Y+M+D+h+m+s;
			var tr = $("<tr><td>" + hash + "</td><td>" +oname_td+"</td><td>"+pname_td+"</td><td>"+oth_td+"</td><td>"+time_bj+"</td></tr>");
                //动态生成列表

            $("table").append(tr);
			/*
			var recordArray = JSON.stringify(record);  
			var split=recordArray.split(",");  
			for(var j=0;j<split.length;j++){
					console.log(split[j]);  
			}  
			*/
			
        }
			}
		else{
			alert("未查询到信息！");
		}
		
    }
});
	}
</script>  
	</head>
	<body>
	<!-- 导航栏 -->
   	<nav class="navbar navbar-fixed-top" role="navigation">
			<div class="container">
				<div class="navbar-header">
        		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                	data-target="#top-navbar-collapse" >
		            <span class="sr-only">切换导航</span>
		            <span class="icon-bar"></span>
		            <span class="icon-bar"></span>
		            <span class="icon-bar"></span>
		        </button>
        	<a class="navbar-brand" href="index.html" id="a1">可信数字资产存证应用</a>
    </div>
    <div class="collapse navbar-collapse" id="top-navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
			<li ><a href="index.html" >首页</a></li>
            <li ><a href="upload.html" >上传</a></li>                      
            <li ><a href="search.html" >查询</a></li> 
            <li><a  href="verification.html" >验证</a></li>
            
        </ul>
    </div>
    </div>
	</nav>
	
	
		<br /><br /><br /><br />
		
	
	<div class="container kv-main">
            <div class="page-header">
            <!-- 上传鉴权文件 -->
            <h1>请选择要鉴权的文件</h1>
            </div>
           
                <br>
				 
				 <input id="file" class="file" type="file" multiple data-min-file-count="1">
		 		<br>
                <button id="cal" type="button" class="btn btn-primary" onclick="calculate()">分析</button>
             
            
            <hr>
	    <!-- 存储服务器中的文件 -->
	    <div class="col-md-12">
	    <div id="messages_2">
			<div id="k"></div>
		</div>
		</div>
		<br>
		<button type="submit" class="btn btn-primary " onClick="search()">校验</button>
		<br>
	    <!-- 上传鉴权的文件 -->
		<br>
	    <div class="col-sm-12 container">
			 <table id="table" style="width:100%;border-collapse:collapse; border:1px solid gray;font-size:18px; text-align:center; " border="1">  
				  
			</table>  
		</div>
    </div>
	</body>
</html>
